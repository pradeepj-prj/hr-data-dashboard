# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## Project Overview

HR Data Dashboard is a Streamlit-based POC dashboard that visualizes synthetic HR data generated by the `hr-data-generator` library. It provides interactive visualizations for exploring employee demographics, organizational structure, compensation, performance, and geographic distribution.

## Development Setup

Python version: 3.10+

### Quick Start
```bash
# Create and activate virtual environment
python -m venv .venv
source .venv/bin/activate

# Install hr-data-generator from local sibling directory
pip install -e ../HR-Data-Generator

# Install this dashboard
pip install -e .

# Run the dashboard
streamlit run src/hr_dashboard/app.py
```

### Dependencies
Main dependencies: streamlit, pandas, numpy, plotly, networkx, pyvis, pydeck

## Architecture

### Application Layout

```
+------------------------------------------------------------------+
|  HR Data Dashboard                          [Regenerate Data] btn |
+------------------------------------------------------------------+
|  SIDEBAR              |  MAIN CONTENT (Tabs)                      |
|  ------------------   |  ---------------------------------------- |
|  Employee Count: 100  |  [Overview | Organization | Compensation |
|  [======|----] slider |   Performance | Attrition | Map]          |
|                       |                                           |
|  Business Unit:       |  Tab content varies by selection          |
|  [x] Engineering      |                                           |
|  [x] Sales            |  Overview: KPIs, seniority dist, emp type |
|  [x] Corporate        |  Organization: Treemap + Network tabs     |
|                       |  Compensation: Salary charts, box plots   |
|  Seniority Level:     |  Performance: Ratings, trends, heatmaps   |
|  [x] 1-Entry          |  Attrition: Turnover analysis, ML insights|
|                       |  Map: Pydeck scatter + location summary   |
|  [x] 2-Junior         |                                           |
|  [x] 3-Mid            |  ------------------------------------------
|  [x] 4-Senior         |  Data Summary section (in sidebar)        |
|  [x] 5-Executive      |  Export buttons (CSV download)            |
|                       |                                           |
|  Salary Range:        |                                           |
|  [======|----] slider |                                           |
|                       |                                           |
|  ATTRITION SETTINGS   |                                           |
|  [x] Enable Attrition |                                           |
|  Rate: 12%            |                                           |
|  ML Noise: 0.2        |                                           |
+------------------------------------------------------------------+
```

### Data Flow

```
User adjusts sidebar → data_manager.py → Session State Cache → Page Visualizations
                            ↓
                    generate_hr_data(n_employees, seed)
                            ↓
                    get_filtered_data(filters)
```

- Data regenerates only when employee count changes or "Regenerate" button clicked
- Filters apply on cached data without regeneration
- `st.session_state` holds both raw and filtered data

### Code Structure

```
src/hr_dashboard/
├── app.py              # Main entry point, tab navigation
├── data_manager.py     # Data generation, caching, filtering
├── filters.py          # Sidebar filter components
├── pages/
│   ├── overview.py     # KPIs, seniority dist, emp type, gender
│   ├── org_chart.py    # Plotly treemap of org hierarchy
│   ├── org_network.py  # Pyvis/NetworkX manager network graph
│   ├── compensation.py # Salary distribution, box plots
│   ├── performance.py  # Ratings, trends, BU×Year heatmap
│   └── geography.py    # Pydeck scatter map, location summary
└── utils/
    └── chart_helpers.py # Reusable Plotly chart functions
```

### Key Modules

#### data_manager.py
- `get_hr_data(n_employees, seed, include_attrition, attrition_rate, noise_std)` - Generate or retrieve cached data
- `force_regenerate(n_employees, seed, include_attrition, attrition_rate, noise_std)` - Force new data generation
- `get_filtered_data(data, filters)` - Apply sidebar filters
- `enrich_employee_data(data)` - Join employee with job, org, location, compensation

#### filters.py
- `render_sidebar_filters(data)` - Render all filter controls
- `render_data_summary(data)` - Display summary metrics in sidebar
- `render_download_buttons(data)` - CSV export buttons

### Data Tables from hr-data-generator

| Table | Description | Key Columns |
|-------|-------------|-------------|
| employee | Hub table, one row per person | employee_id, first_name, last_name, gender, hire_date, location_id, employment_type, employment_status, termination_date, termination_reason, manager_id |
| employee_job_assignment | Time-variant job history | employee_id, job_id, start_date, end_date |
| employee_org_assignment | Time-variant org placement | employee_id, org_id, start_date, end_date |
| employee_compensation | Time-variant salary records | employee_id, base_salary, currency, start_date, end_date, change_reason |
| employee_performance | Annual performance ratings | employee_id, review_period_year, rating (1-5), rating_label |
| job_role | Reference: job catalog | job_id, job_title, job_family, job_level, seniority_level (1-5) |
| organization_unit | Reference: org hierarchy | org_id, org_name, parent_org_id, business_unit |
| location | Reference: office locations | location_id, city, country, region, latitude, longitude |

### Adjustable Parameters

#### Sidebar Filters (user-adjustable at runtime)
| Filter | Type | Range/Options | Default |
|--------|------|---------------|---------|
| Employee Count | Slider | 10-10000, step 10 | 100 |
| Business Unit | Multi-select | Engineering, Sales, Corporate | All selected |
| Seniority Level | Multi-select | 1-Entry, 2-Junior, 3-Mid, 4-Senior, 5-Executive | All selected |
| Salary Range | Range slider | min-max from data | Full range |
| Enable Attrition | Checkbox | On/Off | On |
| Attrition Rate | Slider | 0-30% | 12% |
| ML Difficulty (Noise) | Slider | 0.0-0.5, step 0.05 | 0.2 |

#### Chart Color Schemes (in utils/chart_helpers.py)
```python
BU_COLORS = {
    "Engineering": "#1f77b4",
    "Sales": "#ff7f0e",
    "Corporate": "#2ca02c",
}

SENIORITY_COLORS = {
    1: "#c7e9c0",  # Entry - light green
    2: "#74c476",  # Junior
    3: "#31a354",  # Mid
    4: "#006d2c",  # Senior
    5: "#00441b",  # Executive - darkest green
}

GENDER_COLORS = {
    "male": "#1f77b4",
    "female": "#e377c2",
    "na": "#7f7f7f",
}

ATTRITION_COLORS = {
    "Active": "#2ca02c",      # Green
    "Terminated": "#d62728",  # Red
    "Retired": "#ff7f0e",     # Orange
}

TERMINATION_REASON_COLORS = {
    "Resignation - Career Opportunity": "#1f77b4",
    "Resignation - Personal Reasons": "#aec7e8",
    "Resignation - Relocation": "#ffbb78",
    "Retirement": "#ff7f0e",
    "Termination - Performance": "#d62728",
    "Termination - Policy Violation": "#ff9896",
    "Layoff - Restructuring": "#9467bd",
    "Layoff - Cost Reduction": "#c5b0d5",
}
```

### Page-Specific Features

#### Overview (overview.py)
- KPI cards: Total employees, Avg salary, Avg tenure, Gender split
- Seniority level bar chart
- Employment type pie chart
- Business unit bar chart
- Gender pie chart

#### Organization - Tree View (org_chart.py)
- Plotly treemap: Business Unit → Org Name → Employee
- Color by Business Unit or Seniority Level
- Org summary table with headcount and avg salary

#### Organization - Network View (org_network.py)
- Pyvis interactive network graph
- Shows manager→report relationships
- Configurable: color by seniority/BU, physics simulation, labels
- Max nodes slider for performance

#### Compensation (compensation.py)
- KPIs: Median, Min, Max salary, Range
- Salary histogram
- Box plot by seniority level
- Box plot by business unit
- Change reasons pie chart

#### Performance (performance.py)
- KPIs: Avg rating, Total reviews, High performers %, Needs improvement %
- Rating distribution bar chart (1-5 scale)
- Avg rating trend line by year
- Stacked bar: ratings by year
- Heatmap: Business Unit × Year

#### Attrition (attrition.py)
- KPIs: Attrition Rate %, Active/Terminated/Retired counts, Voluntary vs Involuntary %
- Termination reasons pie chart
- Attrition rate by business unit bar chart
- Attrition rate by performance rating bar chart (ML insight)
- Attrition rate by tenure bucket bar chart
- Attrition rate by seniority level bar chart
- Attrition timeline line chart

#### Geography (geography.py)
- Pydeck scatter map with circles sized by headcount
- Tooltip with city, country, headcount, avg salary
- Summary tables by country and top cities
- Unique locations and countries metrics

## Before Making Changes

### Breaking Change Checklist
1. **Function signatures**: Do changed functions have default values for new params?
2. **Tests**: Do existing tests still pass? Are column names correct?
3. **Imports**: Are new imports available in the environment?
4. **Session state**: Will cache invalidation cause unexpected data regeneration?

### Quick Validation
Run `/validate` skill to check tests before committing:
```bash
cd /Users/I774404/hr-data-dashboard
source .venv/bin/activate
pytest tests/ -v
```

## Running Tests

```bash
pytest tests/
```

Tests verify:
- hr_data_generator produces expected tables and columns
- Data reproducibility with seeds
- Required columns exist in each table
- Value ranges (salary > 0, ratings 1-5, seniority 1-5)

## Common Tasks

### Adding a new visualization page
1. Create `src/hr_dashboard/pages/new_page.py`
2. Implement `render(data: dict[str, pd.DataFrame])` function
3. Import and add tab in `app.py`

### Adding a new filter
1. Add filter widget in `filters.py` → `render_sidebar_filters()`
2. Return filter value in the filters dict
3. Apply filter in `data_manager.py` → `get_filtered_data()`

### Modifying chart styling
- Color palettes in `utils/chart_helpers.py`
- Chart helper functions: `create_bar_chart()`, `create_pie_chart()`, `create_box_plot()`, etc.
